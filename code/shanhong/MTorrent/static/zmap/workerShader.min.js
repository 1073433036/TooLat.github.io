function pointInPolygon(a,b,c){var d,e,f;if(null==c||c.length<3)return!1;for(d=!1,e=c.length,f=0;e>f;f++)sx=c[f].x,sy=c[f].y,ex=c[(f+1)%e].x,ey=c[(f+1)%e].y,(b>=ey&&sy>b||b>=sy&&ey>b)&&(sx-ex)*(b-ey)/(sy-ey)+ex>a&&(d=!d);return d}function unproject(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,q,o,p,r,s;switch(c){case"EPSG3395":for(d=256*Math.pow(2,b),e={_a:2.495320233665337e-8,_b:.5,_c:-2.495320233665337e-8,_d:.5},f=(a.x/d-e._b)/e._a,g=(a.y/d-e._d)/e._c,h={R:6378137,R_MINOR:6356752.314245179},i=180/Math.PI,j=h.R,k=h.R_MINOR/j,l=Math.sqrt(1-k*k),m=Math.exp(-g/j),n=Math.PI/2-2*Math.atan(m),o=0,p=.1;15>o&&Math.abs(p)>1e-7;o++)q=l*Math.sin(n),q=Math.pow((1-q)/(1+q),l/2),p=Math.PI/2-2*Math.atan(m*q)-n,n+=p;return r=n*i,s=f*i/j,{lat:r,lng:s};case"EPSG3857":case"EPSG900913":return d=256*Math.pow(2,b),e={_a:2.495320233665337e-8,_b:.5,_c:-2.495320233665337e-8,_d:.5},f=(a.x/d-e._b)/e._a,g=(a.y/d-e._d)/e._c,h={R:6378137,MAX_LATITUDE:85.0511287798},i=180/Math.PI,r=(2*Math.atan(Math.exp(g/h.R))-Math.PI/2)*i,s=f*i/h.R,{lat:r,lng:s};case"EPSG4326":return d=256*Math.pow(2,b),e={_a:.005555555555555556,_b:1,_c:-.005555555555555556,_d:.5},f=(a.x/d-e._b)/e._a,g=(a.y/d-e._d)/e._c,{lat:g,lng:f}}}function interpLinearColor(a,b,c,d){var e,f;return b>d?null:(e=a.length,f=Math.floor((d-b)/c),f>e-1?a[e-1]:a[f])}function interpNormalColor(a,b,c){var e,d=b.length;if(c<b[0])return null;if(c>=b[d-1])return a[d-1];for(e=0;d-1>e;e+=2){if(b[e]<=c&&b[e+1]>c)return a[e];if(b[e]>c)return a[e-1]}return a[d-2]}function interpModel(a,b,c,d){var f,g,h,i,j,k,l,m,n,o,p,q,r,e=-9999;return c<b.left||c>b.right||d<b.bottom||d>b.top||isNaN(c)||isNaN(d)?e:(f=Math.floor((c-b.left)/b.xgap),g=Math.floor((b.top-d)/b.ygap),0>g||g>=b.ydim-1||0>f||f>=b.xdim-1?e:(h=a[g][f],i=a[g][f+1],j=a[g+1][f],k=a[g+1][f+1],l=b.left+f*b.xgap,m=l+b.xgap,n=b.top-g*b.ygap,o=n-b.ygap,p=interpLine(n,h,o,j,d),q=interpLine(n,i,o,k,d),r=interpLine(l,p,m,q,c)))}function interpLine(a,b,c,d,e){return b+(e-a)/(c-a)*(d-b)}function shadeWithBounds(a,b,c,d,e,f,g,h){var o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,i=4*c.x*c.y,j=new Uint8Array(i),k=9,l=c.x/(k-1),m=c.y/(k-1),n=new Array(k);for(o=0;k>o;o++)n[o]=unproject({x:a.x+l*o,y:a.y+m*o},b.z,d);if(n[0].lng>f.right||n[k-1].lng<f.left||n[0].lat<f.bottom||n[k-1].lat>f.top)return null;for(p=!1,q=new Array(k),r=0;k>r;r++)for(q[r]=new Array(k),s=0;k>s;s++)q[r][s]=pointInPolygon(n[s].lng,n[r].lat,h),p=p||q[r][s];if(!p)return null;for(r=0;k-1>r;r++)for(s=0;k-1>s;s++)if(t=r*m,u=(r+1)*m,v=s*l,w=(s+1)*l,q[r][s]||q[r][s+1]||q[r+1][s]||q[r+1][s+1])if(q[r][s]&&q[r][s+1]&&q[r+1][s]&&q[r+1][s+1])for(x=t;u>x;x++)for(y=v;w>y;y++)z=unproject({x:a.x+y,y:a.y+x},b.z,d),A=interpModel(e,f,z.lng,z.lat),B=g.stepVal?interpLinearColor(g._colors,g.startVal,g.stepVal,A):interpNormalColor(g._colors,g._values,A),null!=B&&(C=4*(x*c.x+y),j[C++]=B[0],j[C++]=B[1],j[C++]=B[2],j[C++]=B[3]);else for(x=t;u>x;x++)for(y=v;w>y;y++)z=unproject({x:a.x+y,y:a.y+x},b.z,d),pointInPolygon(z.lng,z.lat,h)&&(A=interpModel(e,f,z.lng,z.lat),B=g.stepVal?interpLinearColor(g._colors,g.startVal,g.stepVal,A):interpNormalColor(g._colors,g._values,A),null!=B&&(C=4*(x*c.x+y),j[C++]=B[0],j[C++]=B[1],j[C++]=B[2],j[C++]=B[3]));else;return j}function shadeWithoutBounds(a,b,c,d,e,f,g){var l,m,n,o,p,i=4*c.x*c.y,j=new Uint8Array(i),k=0;for(l=0;l<c.y;l++)for(m=0;m<c.x;m++)n=unproject({x:a.x+m,y:a.y+l},b.z,d),o=interpModel(e,f,n.lng,n.lat),p=g.stepVal?interpLinearColor(g._colors,g.startVal,g.stepVal,o):interpNormalColor(g._colors,g._values,o),null==p?(j[k++]=255,j[k++]=255,j[k++]=255,j[k++]=0):(j[k++]=p[0],j[k++]=p[1],j[k++]=p[2],j[k++]=p[3]);return j}onmessage=function(a){var b=a.data.bounds?shadeWithBounds(a.data.nwPoint,a.data.coords,a.data.size,a.data.projName,a.data.dats,a.data.infos,a.data.colortable,a.data.bounds):shadeWithoutBounds(a.data.nwPoint,a.data.coords,a.data.size,a.data.projName,a.data.dats,a.data.infos,a.data.colortable);postMessage({id:a.data.id,size:a.data.size,dats:b})};